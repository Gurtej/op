#
#  Makefile for openpeerstack
#  Copyright 2009-2011. Robin Raymond. All rights reserved.
#
# This file is part of openpeerstack.
##

if [ -z "$(PREFIX)" ]; then PREFIX=/usr; fi


LIB_NAME=openpeerstack
ARNAME=lib$(LIB_NAME).a

CC=g++
CFLAGS=-fPIC#-Wall -fPIC
LDFLAGS=-D_DEBUG -D_LIB

INC=-I../../../ -I$(PREFIX)/include 
SRC=../../../hookflash/stack/cpp
SRC_MESSAGE=../../../hookflash/stack/message/cpp

OUT_DIR=out
OUT_BIN_DIR=$(OUT_DIR)/bin
OUT_OBJ_DIR=$(OUT_DIR)/obj
OUT_OBJ_DIR_MESSAGE=$(OUT_DIR)/obj/message
OUT_LIB_DIR=$(OUT_DIR)/lib
OUT_INCLUDE_DIR=$(OUT_DIR)/include

OBJS=$(patsubst $(SRC)/%.cpp,%.o,$(wildcard $(SRC)/*.cpp))
OBJS_MESSAGE=$(patsubst $(SRC_MESSAGE)/%.cpp,%.o,$(wildcard $(SRC_MESSAGE)/*.cpp))
OBJ_PATHS=$(addprefix $(OUT_OBJ_DIR)/,$(OBJS))
OBJ_PATHS+=$(addprefix $(OUT_OBJ_DIR_MESSAGE)/,$(OBJS_MESSAGE))

all:prepare copy_headers build


copy_headers:
	cp ../../../hookflash/stack/*.h $(OUT_INCLUDE_DIR)/hookflash/stack/
	cp ../../../hookflash/stack/internal/*.h $(OUT_INCLUDE_DIR)/hookflash/stack/internal


build: $(OBJS) archive


%.o: $(SRC)/%.cpp
	$(CC) $(INC) $(LDFLAGS) $(CFLAGS) -c -o $(OUT_OBJ_DIR)/$@ $<


archive:
	#ar rcs $(OUT_LIB_DIR)/$(LIB_NAME)/$(ARNAME) $(OBJ_PATHS)
	ar rcs $(OUT_LIB_DIR)/$(ARNAME) $(OBJ_PATHS)

prepare:
	mkdir -p $(OUT_OBJ_DIR)
	mkdir -p $(OUT_LIB_DIR)
	mkdir -p $(OUT_INCLUDE_DIR)/hookflash/stack/internal


clean: prepare
	#rm -r $(OUT_BIN_DIR)
	rm $(OUT_OBJ_DIR)/*.o
	rm $(OUT_LIB_DIR)/$(ARNAME)
	rm $(OUT_INCLUDE_DIR)/hookflash/stack/*.h

install:
	mkdir -p $(PREFIX)
	cp -R $(OUT_INCLUDE_DIR) $(PREFIX)
	cp -R $(OUT_LIB_DIR) $(PREFIX)
	#cp -R $(OUT_BIN_DIR) $(PREFIX)

